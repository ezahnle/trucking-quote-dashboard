<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ed Zahnle - Trucking Insurance Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 18px;
        }
        
        .refresh-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #ecf0f1;
        }
        
        .refresh-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .refresh-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        
        .status-message {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: 500;
        }
        
        .status-loading {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #2196f3;
        }
        
        .status-success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }
        
        .status-error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
        }
        
        .metric-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }
        
        .metric-value {
            font-size: 36px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .metric-label {
            color: #7f8c8d;
            font-size: 16px;
            font-weight: 500;
        }
        
        .dashboard-content {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .tab-nav {
            background: #f8f9fa;
            padding: 0 30px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            overflow-x: auto;
        }
        
        .tab-button {
            padding: 20px 25px;
            border: none;
            background: transparent;
            font-size: 16px;
            font-weight: 500;
            color: #6c757d;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .tab-button.active {
            color: #3498db;
            border-bottom-color: #3498db;
            background: white;
        }
        
        .tab-button:hover:not(.active) {
            color: #495057;
            background: #e9ecef;
        }
        
        .tab-content {
            padding: 30px;
            min-height: 400px;
        }
        
        .hidden {
            display: none;
        }
        
        .routing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .routing-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .routing-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .routing-card.first {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border-color: #27ae60;
        }
        
        .routing-card.second {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border-color: #f39c12;
        }
        
        .routing-card.third {
            background: linear-gradient(135deg, #cce5ff, #b3d9ff);
            border-color: #3498db;
        }
        
        .routing-badge {
            position: absolute;
            top: -12px;
            left: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            color: white;
            text-transform: uppercase;
        }
        
        .routing-badge.first { background: #27ae60; }
        .routing-badge.second { background: #f39c12; }
        .routing-badge.third { background: #3498db; }
        .routing-badge.other { background: #6c757d; }
        
        .carrier-name {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
            margin: 15px 0;
        }
        
        .carrier-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .stat-item {
            background: rgba(255,255,255,0.7);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .data-table th {
            background: #3498db;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        .performance-score {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            display: inline-block;
        }
        
        .score-high {
            background: #d4edda;
            color: #155724;
        }
        
        .score-medium {
            background: #fff3cd;
            color: #856404;
        }
        
        .score-low {
            background: #f8d7da;
            color: #721c24;
        }
        
        .no-data {
            text-align: center;
            padding: 50px;
            color: #6c757d;
            font-size: 18px;
        }
        
        .filters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        
        .filter-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }
        
        .filter-group select:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .carrier-insights {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border-left: 4px solid #27ae60;
        }
        
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .insight-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border-left: 3px solid #3498db;
        }
        
        .insight-carrier {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .insight-details {
            font-size: 14px;
            color: #6c757d;
            line-height: 1.4;
        }
        
        .edit-btn {
            transition: all 0.3s ease;
        }
        
        .edit-btn:hover {
            transform: translateY(-1px);
        }
        
        .debug-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            color: #6c757d;
            max-height: 200px;
            overflow-y: auto;
        }

        .marketable-quotes {
            display: grid;
            gap: 20px;
        }

        .quote-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 25px;
            transition: all 0.3s ease;
        }

        .quote-card:hover {
            border-color: #3498db;
            box-shadow: 0 5px 20px rgba(52, 152, 219, 0.1);
        }

        .quote-header {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            margin-bottom: 20px;
            align-items: start;
        }

        .quote-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .quote-detail {
            display: flex;
            flex-direction: column;
        }

        .quote-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .quote-value {
            font-size: 16px;
            color: #2c3e50;
            font-weight: 500;
        }

        .carrier-selection {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid #f1f3f4;
        }

        .carrier-section {
            margin-bottom: 20px;
        }

        .carrier-section h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .carrier-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }

        .carrier-checkbox {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .carrier-checkbox:hover {
            background: #e9ecef;
        }

        .carrier-checkbox input {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .carrier-checkbox label {
            cursor: pointer;
            font-weight: 500;
            color: #495057;
        }

        .submit-button {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .submit-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .submit-button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .already-submitted {
            background: #fff3cd;
            border-color: #ffc107;
            opacity: 0.7;
        }

        .submitted-badge {
            background: #ffc107;
            color: #856404;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Ed Zahnle - Trucking Insurance Analytics</h1>
            <p>Real-time carrier performance and quote routing optimization</p>
            
            <div class="refresh-section">
                <div id="last-updated" style="color: #6c757d;">Never updated</div>
                <button class="refresh-btn" onclick="loadData()" id="refresh-btn">
                    Refresh Data
                </button>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="status-container"></div>

        <!-- Metrics -->
        <div class="metrics-grid" id="metrics-grid" style="display: none;">
            <div class="metric-card">
                <div class="metric-icon">üìã</div>
                <div class="metric-value" id="total-quotes">0</div>
                <div class="metric-label">Total Quotes</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">‚úÖ</div>
                <div class="metric-value" id="bound-quotes">0</div>
                <div class="metric-label">Bound Policies</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">üìà</div>
                <div class="metric-value" id="success-rate">0%</div>
                <div class="metric-label">Success Rate</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">üèÜ</div>
                <div class="metric-value" id="top-carrier">-</div>
                <div class="metric-label">Top Carrier</div>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div class="dashboard-content" id="dashboard-content" style="display: none;">
            <div class="tab-nav">
                <button class="tab-button active" onclick="showTab('routing')">Smart Routing</button>
                <button class="tab-button" onclick="showTab('market')">Market Account</button>
                <button class="tab-button" onclick="showTab('performance')">Carrier Performance</button>
                <button class="tab-button" onclick="showTab('analysis')">Operation Analysis</button>
                <button class="tab-button" onclick="showTab('submissions')">Recent Submissions</button>
            </div>

            <!-- Market Account Tab -->
            <div id="market-tab" class="tab-content hidden">
                <h2 style="color: #2c3e50; margin-bottom: 20px;">Market Account to Carriers</h2>
                
                <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #2196f3;">
                    <h3 style="color: #1976d2; margin-bottom: 10px;">How It Works</h3>
                    <p style="color: #424242; margin: 0;">Select a quote below, choose which carriers to market it to, and click "Submit to Carriers". This will automatically add rows to your Carrier Attempts sheet with today's date.</p>
                </div>

                <div id="marketable-quotes" class="marketable-quotes"></div>
            </div>

            <!-- Smart Routing Tab -->
            <div id="routing-tab" class="tab-content">
                <h2 style="color: #2c3e50; margin-bottom: 20px;">Smart Carrier Routing</h2>
                
                <div class="carrier-insights">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: #27ae60; margin: 0;">Carrier Directory & Underwriter Information</h3>
                        <div>
                            <button onclick="editCarrierInfo()" class="edit-btn" style="background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 6px; margin-right: 10px; cursor: pointer;">Edit Info</button>
                            <button onclick="addNewCarrier()" class="edit-btn" style="background: #27ae60; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Add Carrier</button>
                        </div>
                    </div>
                    <div id="carrier-info-display" class="insights-grid"></div>
                    
                    <!-- Edit Modal -->
                    <div id="edit-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 600px; max-height: 80%; overflow-y: auto;">
                            <h3 style="margin-bottom: 20px; color: #2c3e50;">Edit Carrier Information</h3>
                            <div id="edit-form-container"></div>
                            <div style="text-align: right; margin-top: 20px;">
                                <button onclick="cancelEdit()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 6px; margin-right: 10px; cursor: pointer;">Cancel</button>
                                <button onclick="saveCarrierInfo()" style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">Save Changes</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="filters">
                    <div class="filter-group">
                        <label>Operation Type:</label>
                        <select id="operation-filter" onchange="updateRouting()">
                            <option value="all">All Operation Types</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Commodity Type:</label>
                        <select id="commodity-filter" onchange="updateRouting()">
                            <option value="all">All Commodities</option>
                        </select>
                    </div>
                </div>

                <h3 style="color: #2c3e50; margin-bottom: 15px;">Recommended Carrier Order</h3>
                <div id="routing-recommendations" class="routing-grid"></div>
            </div>

            <!-- Carrier Performance Tab -->
            <div id="performance-tab" class="tab-content hidden">
                <h2 style="color: #2c3e50; margin-bottom: 20px;">Carrier Performance Analysis</h2>
                <table class="data-table" id="carrier-table">
                    <thead>
                        <tr>
                            <th>Carrier Name</th>
                            <th>Submitted</th>
                            <th>Quoted</th>
                            <th>Won</th>
                            <th>Quote Rate</th>
                            <th>Win Rate</th>
                            <th>Performance</th>
                        </tr>
                    </thead>
                    <tbody id="carrier-table-body"></tbody>
                </table>
            </div>

            <!-- Analysis Tab -->
            <div id="analysis-tab" class="tab-content hidden">
                <h2 style="color: #2c3e50; margin-bottom: 20px;">Operation & Commodity Analysis</h2>
                <div id="analysis-content"></div>
            </div>

            <!-- Submissions Tab -->
            <div id="submissions-tab" class="tab-content hidden">
                <h2 style="color: #2c3e50; margin-bottom: 20px;">Recent Quote Submissions</h2>
                <table class="data-table" id="submissions-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Customer</th>
                            <th>DOT Number</th>
                            <th>Operation Type</th>
                            <th>Commodity</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="submissions-table-body"></tbody>
                </table>
            </div>
        </div>
        
        <!-- Debug Information -->
        <div id="debug-info" class="debug-info" style="display: none;">
            <strong>Debug Information:</strong><br>
            <div id="debug-content"></div>
        </div>
    </div>

    <script>
        // Your Google Apps Script URL
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw3663y8LoEPt1ZNkhYoYVFd4uRi3QyLuNJuZ6pKmI6-sLZyEwKVI7GA1jOArqF9SfvaA/exec';
        
        // Global data storage
        let dashboardData = {
            quotes: [],
            carrierAttempts: [],
            lastUpdated: null
        };

        // Carrier information storage
        let carrierInfo = {
            'Progressive Commercial': {
                contact: 'Agent codes: 36046 or 66929',
                territory: 'California dump trucks - AUTOMATIC first choice',
                specialties: 'WON\'T DO UIIA containers',
                underwriter: 'Ed Zahnle - Premier Producer',
                notes: 'Best rates for CA dump trucks'
            },
            'Sentry Select': {
                contact: 'Payment: 800-742-5681',
                territory: 'National coverage',
                specialties: 'Will do UIIA containers, Avoids Long Beach/LA/NJ ports',
                underwriter: 'Regional underwriter',
                notes: 'Good alternative for containers'
            },
            'Bellingham': {
                contact: 'Nicole Direct: 360-922-5244',
                territory: '250 mile radius and under market',
                specialties: 'Regional specialist, Requires full docs package',
                underwriter: 'Nicole - Direct contact',
                notes: 'Local/regional focus only'
            },
            'IAT Insurance': {
                contact: 'Fleet department',
                territory: 'Multi-state coverage',
                specialties: 'Fleet specialist (8+ trucks), Strong long haul appetite',
                underwriter: 'Fleet underwriting team',
                notes: 'Best for multiple unit operations'
            }
        };

        // Debug logging
        function debugLog(message, data = null) {
            console.log(message, data);
            const debugInfo = document.getElementById('debug-info');
            const debugContent = document.getElementById('debug-content');
            
            debugInfo.style.display = 'block';
            debugContent.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
            if (data) {
                debugContent.innerHTML += `<pre>${JSON.stringify(data, null, 2).substring(0, 500)}...</pre>`;
            }
            
            // Auto-scroll to bottom
            debugContent.scrollTop = debugContent.scrollHeight;
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('Page loaded, initializing...');
            loadCarrierInfo(); // Load carrier information first
            loadData();
        });

        async function loadData() {
            const statusContainer = document.getElementById('status-container');
            const refreshBtn = document.getElementById('refresh-btn');
            
            try {
                debugLog('Starting data load...');
                
                // Show loading state
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'Loading...';
                showStatus('loading', 'Loading data from Google Sheets...');
                
                // Use JSONP with proper error handling and timeout
                const data = await loadDataWithJSONP();
                
                debugLog('Data received from JSONP:', {
                    hasQuotes: !!(data && data.quotes),
                    quotesLength: data && data.quotes ? data.quotes.length : 0,
                    hasCarrierAttempts: !!(data && data.carrierAttempts),
                    carrierAttemptsLength: data && data.carrierAttempts ? data.carrierAttempts.length : 0,
                    hasError: !!(data && data.error)
                });
                
                if (data && data.error) {
                    throw new Error(data.error);
                }
                
                if (!data) {
                    throw new Error('No data received from Google Apps Script');
                }
                
                // Store data with fallbacks
                dashboardData.quotes = data.quotes || [];
                dashboardData.carrierAttempts = data.carrierAttempts || [];
                dashboardData.lastUpdated = data.lastUpdated || new Date().toISOString();
                
                debugLog('Data stored successfully:', {
                    quotes: dashboardData.quotes.length,
                    carrierAttempts: dashboardData.carrierAttempts.length
                });
                
                // Update UI
                updateMetrics();
                populateFilters();
                updateAllTabs();
                
                // Show dashboard
                document.getElementById('metrics-grid').style.display = 'grid';
                document.getElementById('dashboard-content').style.display = 'block';
                
                showStatus('success', `Data loaded successfully! ${dashboardData.quotes.length} quotes, ${dashboardData.carrierAttempts.length} carrier attempts`);
                
                // Update last updated time
                const lastUpdated = new Date(dashboardData.lastUpdated);
                document.getElementById('last-updated').textContent = 
                    `Last updated: ${lastUpdated.toLocaleDateString()} at ${lastUpdated.toLocaleTimeString()}`;
                
            } catch (error) {
                debugLog('Error loading data:', error);
                console.error('Error loading data:', error);
                showStatus('error', `Failed to load data: ${error.message}`);
                
                // Show sample data for testing
                loadSampleData();
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'Refresh Data';
            }
        }

        function loadDataWithJSONP() {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonpCallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                const timeoutDuration = 15000; // 15 seconds
                let timeoutId;
                
                debugLog('Creating JSONP request with callback:', callbackName);
                
                // Clean up function
                const cleanup = () => {
                    if (timeoutId) clearTimeout(timeoutId);
                    const script = document.getElementById('jsonp-script-' + callbackName);
                    if (script && script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    if (window[callbackName]) {
                        delete window[callbackName];
                    }
                };
                
                // Create global callback function
                window[callbackName] = function(data) {
                    debugLog('JSONP callback received data:', data);
                    cleanup();
                    resolve(data);
                };
                
                // Set up timeout
                timeoutId = setTimeout(() => {
                    debugLog('JSONP request timed out');
                    cleanup();
                    reject(new Error(`Request timeout (${timeoutDuration/1000}s) - Google Apps Script may be slow or unresponsive`));
                }, timeoutDuration);
                
                // Create script element
                const script = document.createElement('script');
                script.id = 'jsonp-script-' + callbackName;
                
                script.onerror = function(error) {
                    debugLog('JSONP script error:', error);
                    cleanup();
                    reject(new Error('Failed to load script - check Google Apps Script URL and permissions'));
                };
                
                // Build URL with parameters
                const url = `${APPS_SCRIPT_URL}?action=getDashboardData&callback=${callbackName}&timestamp=${Date.now()}&_=${Math.random()}`;
                debugLog('JSONP URL:', url);
                
                script.src = url;
                document.head.appendChild(script);
            });
        }

        function loadSampleData() {
            debugLog('Loading sample data for testing...');
            
            // Sample data for testing when Google Sheets is unavailable
            dashboardData = {
                quotes: [
                    { 'Quote ID (USDOT)': '3466447', 'Customer Name': 'ECU991 Logistics', 'Operation Type': 'Dump Truck', 'Commodity': 'Sand/Gravel', 'Status': 'Bound', 'Date': '2025-08-29' },
                    { 'Quote ID (USDOT)': '4440022', 'Customer Name': 'Chad Braden', 'Operation Type': 'Long Haul', 'Commodity': 'General Freight', 'Status': 'Quoted', 'Date': '2025-08-28' },
                    { 'Quote ID (USDOT)': '3659714', 'Customer Name': 'Panama Trucking', 'Operation Type': 'Regional', 'Commodity': 'Containers', 'Status': 'Pending', 'Date': '2025-08-27' }
                ],
                carrierAttempts: [
                    { 'Quote ID (USDOT)': '3466447', 'Carrier Name': 'Progressive', 'Quoted (Y/N)': 'Y', 'Won (Y/N)': 'Y' },
                    { 'Quote ID (USDOT)': '4440022', 'Carrier Name': 'Sentry', 'Quoted (Y/N)': 'Y', 'Won (Y/N)': 'N' },
                    { 'Quote ID (USDOT)': '4440022', 'Carrier Name': 'Bellingham', 'Quoted (Y/N)': 'N', 'Won (Y/N)': 'N' },
                    { 'Quote ID (USDOT)': '3659714', 'Carrier Name': 'ATM', 'Quoted (Y/N)': 'Y', 'Won (Y/N)': 'N' }
                ],
                lastUpdated: new Date().toISOString()
            };
            
            // Update UI with sample data
            updateMetrics();
            populateFilters();
            updateAllTabs();
            
            // Show dashboard
            document.getElementById('metrics-grid').style.display = 'grid';
            document.getElementById('dashboard-content').style.display = 'block';
            
            showStatus('error', 'Using sample data - unable to connect to Google Sheets');
            
            debugLog('Sample data loaded successfully');
        }

        // Carrier Information Management Functions
        function loadCarrierInfo() {
            // Load carrier info from localStorage if available
            const saved = localStorage.getItem('edZahnleCarrierInfo');
            if (saved) {
                try {
                    carrierInfo = JSON.parse(saved);
                    debugLog('Loaded carrier info from localStorage');
                } catch (e) {
                    debugLog('Error loading saved carrier info, using defaults');
                }
            }
            displayCarrierInfo();
        }

        function displayCarrierInfo() {
            const container = document.getElementById('carrier-info-display');
            container.innerHTML = Object.entries(carrierInfo).map(([carrier, info]) => `
                <div class="insight-card" style="position: relative;">
                    <div class="insight-carrier">${carrier}</div>
                    <div class="insight-details">
                        <strong>Contact:</strong> ${info.contact || 'Not specified'}<br>
                        <strong>Territory:</strong> ${info.territory || 'Not specified'}<br>
                        <strong>Specialties:</strong> ${info.specialties || 'Not specified'}<br>
                        <strong>Underwriter:</strong> ${info.underwriter || 'Not specified'}<br>
                        <strong>Notes:</strong> ${info.notes || 'None'}
                    </div>
                    <button onclick="deleteCarrier('${carrier}')" style="position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; border-radius: 3px; width: 20px; height: 20px; font-size: 12px; cursor: pointer;">√ó</button>
                </div>
            `).join('');
        }

        function editCarrierInfo() {
            const modal = document.getElementById('edit-modal');
            const container = document.getElementById('edit-form-container');
            
            container.innerHTML = Object.entries(carrierInfo).map(([carrier, info]) => `
                <div style="margin-bottom: 30px; padding: 20px; border: 1px solid #dee2e6; border-radius: 8px;">
                    <h4 style="margin-bottom: 15px; color: #2c3e50;">${carrier}</h4>
                    <div style="display: grid; gap: 10px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Contact Information:</label>
                            <input type="text" id="contact_${carrier.replace(/\s+/g, '_')}" value="${info.contact || ''}" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Territory/Coverage:</label>
                            <input type="text" id="territory_${carrier.replace(/\s+/g, '_')}" value="${info.territory || ''}" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Specialties/Restrictions:</label>
                            <textarea id="specialties_${carrier.replace(/\s+/g, '_')}" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; height: 60px;">${info.specialties || ''}</textarea>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Underwriter/Rep:</label>
                            <input type="text" id="underwriter_${carrier.replace(/\s+/g, '_')}" value="${info.underwriter || ''}" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Notes:</label>
                            <textarea id="notes_${carrier.replace(/\s+/g, '_')}" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; height: 60px;">${info.notes || ''}</textarea>
                        </div>
                    </div>
                </div>
            `).join('');
            
            modal.style.display = 'block';
        }

        function addNewCarrier() {
            const carrierName = prompt('Enter carrier name:');
            if (carrierName && carrierName.trim()) {
                const cleanName = carrierName.trim();
                if (!carrierInfo[cleanName]) {
                    carrierInfo[cleanName] = {
                        contact: '',
                        territory: '',
                        specialties: '',
                        underwriter: '',
                        notes: ''
                    };
                    displayCarrierInfo();
                    saveCarrierInfoToStorage();
                    debugLog('Added new carrier:', cleanName);
                } else {
                    alert('Carrier already exists!');
                }
            }
        }

        function deleteCarrier(carrierName) {
            if (confirm(`Delete ${carrierName} from the directory?`)) {
                delete carrierInfo[carrierName];
                displayCarrierInfo();
                saveCarrierInfoToStorage();
                debugLog('Deleted carrier:', carrierName);
            }
        }

        function saveCarrierInfo() {
            // Save all carrier information from the form
            Object.keys(carrierInfo).forEach(carrier => {
                const cleanCarrier = carrier.replace(/\s+/g, '_');
                const contact = document.getElementById(`contact_${cleanCarrier}`);
                const territory = document.getElementById(`territory_${cleanCarrier}`);
                const specialties = document.getElementById(`specialties_${cleanCarrier}`);
                const underwriter = document.getElementById(`underwriter_${cleanCarrier}`);
                const notes = document.getElementById(`notes_${cleanCarrier}`);
                
                if (contact) carrierInfo[carrier].contact = contact.value;
                if (territory) carrierInfo[carrier].territory = territory.value;
                if (specialties) carrierInfo[carrier].specialties = specialties.value;
                if (underwriter) carrierInfo[carrier].underwriter = underwriter.value;
                if (notes) carrierInfo[carrier].notes = notes.value;
            });
            
            saveCarrierInfoToStorage();
            displayCarrierInfo();
            cancelEdit();
            debugLog('Carrier information saved');
        }

        function saveCarrierInfoToStorage() {
            localStorage.setItem('edZahnleCarrierInfo', JSON.stringify(carrierInfo));
        }

        function cancelEdit() {
            document.getElementById('edit-modal').style.display = 'none';
        }

        function showStatus(type, message) {
            const statusContainer = document.getElementById('status-container');
            statusContainer.innerHTML = `
                <div class="status-message status-${type}">
                    ${message}
                </div>
            `;
            
            // Auto-hide success messages
            if (type === 'success') {
                setTimeout(() => {
                    statusContainer.innerHTML = '';
                }, 5000);
            }
        }

        function updateMetrics() {
            const totalQuotes = dashboardData.quotes.length;
            
            // Check for different possible status values
            const boundQuotes = dashboardData.quotes.filter(q => {
                const status = (q.Status || q.status || '').toString().toLowerCase();
                return status.includes('bound') || 
                       status.includes('quoted') ||
                       status.includes('won') ||
                       status.includes('complete');
            }).length;
            
            const successRate = totalQuotes > 0 ? ((boundQuotes / totalQuotes) * 100).toFixed(1) : 0;
            
            // Find top carrier - check multiple possible field names
            const carrierWins = {};
            dashboardData.carrierAttempts.forEach(attempt => {
                const won = (attempt['Won (Y/N)'] || '').toString().toUpperCase() === 'Y' || 
                           (attempt['Won (Y/N)'] || '').toString().toLowerCase() === 'yes' || 
                           (attempt.Won || '').toString().toUpperCase() === 'Y' || 
                           (attempt.won || '').toString().toLowerCase() === 'yes';
                           
                const carrierName = attempt['Carrier Name'] || attempt.carrierName || attempt.carrier;
                
                if (won && carrierName) {
                    carrierWins[carrierName] = (carrierWins[carrierName] || 0) + 1;
                }
            });
            
            const topCarrier = Object.entries(carrierWins)
                .sort((a, b) => b[1] - a[1])[0]?.[0] || 'No wins yet';
            
            document.getElementById('total-quotes').textContent = totalQuotes;
            document.getElementById('bound-quotes').textContent = boundQuotes;
            document.getElementById('success-rate').textContent = successRate + '%';
            document.getElementById('top-carrier').textContent = topCarrier;
            
            debugLog('Metrics updated:', { totalQuotes, boundQuotes, successRate, topCarrier });
        }

        function populateFilters() {
            // Get unique operation types and commodities
            const operationTypes = [...new Set(dashboardData.quotes.map(q => 
                q['Operation Type'] || q.operationType || q.operation || q.Operation
            ).filter(Boolean))];
            
            const commodities = [...new Set(dashboardData.quotes.map(q => 
                q['Commodity'] || q.commodity || q.Commodity
            ).filter(Boolean))];
            
            // Populate operation filter
            const operationFilter = document.getElementById('operation-filter');
            operationFilter.innerHTML = '<option value="all">All Operation Types</option>';
            operationTypes.forEach(type => {
                operationFilter.innerHTML += `<option value="${type}">${type}</option>`;
            });
            
            // Populate commodity filter
            const commodityFilter = document.getElementById('commodity-filter');
            commodityFilter.innerHTML = '<option value="all">All Commodities</option>';
            commodities.forEach(commodity => {
                commodityFilter.innerHTML += `<option value="${commodity}">${commodity}</option>`;
            });
            
            debugLog('Filters populated:', { operationTypes: operationTypes.length, commodities: commodities.length });
        }

        function showTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            
            // Update content based on tab
            if (tabName === 'routing') updateRouting();
            else if (tabName === 'market') updateMarketAccount();
            else if (tabName === 'performance') updateCarrierPerformance();
            else if (tabName === 'analysis') updateAnalysis();
            else if (tabName === 'submissions') updateSubmissions();
            
            debugLog('Tab switched to:', tabName);
        }

        function updateAllTabs() {
            updateRouting();
            updateMarketAccount();
            updateCarrierPerformance();
            updateAnalysis();
            updateSubmissions();
            debugLog('All tabs updated');
        }

        function updateRouting() {
            const operationType = document.getElementById('operation-filter').value;
            const commodityType = document.getElementById('commodity-filter').value;
            
            // Filter quotes
            const filteredQuotes = dashboardData.quotes.filter(q => {
                const qOpType = q['Operation Type'] || q.operationType || q.operation || q.Operation;
                const qCommodity = q['Commodity'] || q.commodity || q.Commodity;
                
                return (operationType === 'all' || qOpType === operationType) &&
                       (commodityType === 'all' || qCommodity === commodityType);
            });
            
            // Get relevant carrier attempts
            const quoteIds = filteredQuotes.map(q => 
                q['Quote ID (USDOT)'] || q.quoteId || q.id || q.ID
            );
            
            const relevantAttempts = dashboardData.carrierAttempts.filter(a => {
                const attemptQuoteId = a['Quote ID (USDOT)'] || a.quoteId || a.id || a.ID;
                return quoteIds.includes(attemptQuoteId);
            });
            
            // Calculate carrier performance
            const carrierStats = {};
            relevantAttempts.forEach(attempt => {
                const carrier = attempt['Carrier Name'] || attempt.carrierName || attempt.carrier;
                if (!carrier) return;
                
                if (!carrierStats[carrier]) {
                    carrierStats[carrier] = { attempts: 0, quotes: 0, wins: 0 };
                }
                
                carrierStats[carrier].attempts++;
                
                const quoted = (attempt['Quoted (Y/N)'] || '').toString().toUpperCase() === 'Y' || 
                              (attempt['Quoted (Y/N)'] || '').toString().toLowerCase() === 'yes';
                              
                const won = (attempt['Won (Y/N)'] || '').toString().toUpperCase() === 'Y' || 
                           (attempt['Won (Y/N)'] || '').toString().toLowerCase() === 'yes';
                
                if (quoted) {
                    carrierStats[carrier].quotes++;
                    if (won) {
                        carrierStats[carrier].wins++;
                    }
                }
            });
            
            // Sort carriers by performance
            const recommendations = Object.entries(carrierStats)
                .map(([carrier, stats]) => ({
                    carrier,
                    attempts: stats.attempts,
                    quoteRate: stats.attempts > 0 ? (stats.quotes / stats.attempts * 100).toFixed(1) : 0,
                    winRate: stats.quotes > 0 ? (stats.wins / stats.quotes * 100).toFixed(1) : 0,
                    score: stats.attempts > 0 ? (stats.quotes * stats.wins) / stats.attempts : 0
                }))
                .sort((a, b) => b.score - a.score);
            
            // Display recommendations
            const container = document.getElementById('routing-recommendations');
            
            if (recommendations.length === 0) {
                container.innerHTML = '<div class="no-data">No carrier data available for the selected filters</div>';
                return;
            }
            
            container.innerHTML = recommendations.slice(0, 6).map((rec, index) => {
                const priority = index === 0 ? 'first' : index === 1 ? 'second' : index === 2 ? 'third' : 'other';
                const label = index === 0 ? '1st Choice' : index === 1 ? '2nd Choice' : index === 2 ? '3rd Choice' : `${index + 1}th Option`;
                
                return `
                    <div class="routing-card ${priority}">
                        <div class="routing-badge ${priority}">${label}</div>
                        <div class="carrier-name">${rec.carrier}</div>
                        <div class="carrier-stats">
                            <div class="stat-item">
                                <div class="stat-value">${rec.quoteRate}%</div>
                                <div class="stat-label">Quote Rate</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${rec.winRate}%</div>
                                <div class="stat-label">Win Rate</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${rec.attempts}</div>
                                <div class="stat-label">Attempts</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${rec.score.toFixed(1)}</div>
                                <div class="stat-label">Score</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateMarketAccount() {
            const container = document.getElementById('marketable-quotes');
            
            // Find quotes that can be marketed (Status indicates they need carriers)
            const marketableQuotes = dashboardData.quotes.filter(quote => {
                const status = (quote.Status || quote.status || '').toString().toLowerCase();
                return status.includes('new') || 
                       status.includes('pending') || 
                       status.includes('not quoted') ||
                       status === '' ||
                       !status.includes('bound');
            });

            if (marketableQuotes.length === 0) {
                container.innerHTML = '<div class="no-data">No quotes ready for marketing. All quotes appear to be completed or bound.</div>';
                return;
            }

            // Get already submitted carriers for each quote
            const submittedCarriers = {};
            dashboardData.carrierAttempts.forEach(attempt => {
                const quoteId = attempt['Quote ID (USDOT)'] || attempt.quoteId;
                const carrier = attempt['Carrier Name'] || attempt.carrierName;
                if (quoteId && carrier) {
                    if (!submittedCarriers[quoteId]) submittedCarriers[quoteId] = [];
                    submittedCarriers[quoteId].push(carrier);
                }
            });

            container.innerHTML = marketableQuotes.map((quote, index) => {
                const quoteId = quote['Quote ID (USDOT)'] || quote.quoteId;
                const operation = quote['Operation Type'] || quote.operationType || '';
                const commodity = quote['Commodity'] || quote.commodity || '';
                const alreadySubmitted = submittedCarriers[quoteId] || [];
                
                const recommendations = getSmartCarrierRecommendations(operation, commodity);
                const allCarriers = [...recommendations.priority, ...recommendations.secondary, ...recommendations.other];
                
                return `
                    <div class="quote-card ${alreadySubmitted.length > 0 ? 'already-submitted' : ''}" id="quote-${index}">
                        <div class="quote-header">
                            <div>
                                <h3 style="color: #2c3e50; margin-bottom: 10px;">
                                    ${quote['Customer Name'] || 'Unknown Customer'} 
                                    <span style="color: #6c757d; font-size: 16px; font-weight: normal;">(DOT: ${quoteId})</span>
                                </h3>
                                ${alreadySubmitted.length > 0 ? `<div class="submitted-badge">Already marketed to ${alreadySubmitted.length} carrier${alreadySubmitted.length > 1 ? 's' : ''}</div>` : ''}
                            </div>
                        </div>
                        
                        <div class="quote-info">
                            <div class="quote-detail">
                                <div class="quote-label">Operation Type</div>
                                <div class="quote-value">${operation || 'Not specified'}</div>
                            </div>
                            <div class="quote-detail">
                                <div class="quote-label">Commodity</div>
                                <div class="quote-value">${commodity || 'Not specified'}</div>
                            </div>
                            <div class="quote-detail">
                                <div class="quote-label">Fleet Size</div>
                                <div class="quote-value">${quote['Fleet Size (Trucks)'] || '1'} truck${quote['Fleet Size (Trucks)'] > 1 ? 's' : ''}</div>
                            </div>
                            <div class="quote-detail">
                                <div class="quote-label">Radius</div>
                                <div class="quote-value">${quote.Radius || 'Not specified'} miles</div>
                            </div>
                            <div class="quote-detail">
                                <div class="quote-label">State</div>
                                <div class="quote-value">${quote.State || 'Not specified'}</div>
                            </div>
                            <div class="quote-detail">
                                <div class="quote-label">Status</div>
                                <div class="quote-value">${quote.Status || 'Pending'}</div>
                            </div>
                        </div>

                        <div class="carrier-selection">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h4 style="color: #2c3e50; margin: 0;">Select Carriers to Market To:</h4>
                                <div>
                                    <button onclick="selectAllRecommended(${index})" style="background: #3498db; color: white; border: none; padding: 6px 12px; border-radius: 4px; margin-right: 10px; cursor: pointer; font-size: 12px;">Select Recommended</button>
                                    <button onclick="clearAllCarriers(${index})" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Clear All</button>
                                </div>
                            </div>

                            ${recommendations.priority.length > 0 ? `
                                <div class="carrier-section">
                                    <h4 style="color: #27ae60;">üéØ Recommended (Based on Operation/Commodity)</h4>
                                    <div class="carrier-grid">
                                        ${recommendations.priority.map(carrier => `
                                            <div class="carrier-checkbox" style="background: ${alreadySubmitted.includes(carrier) ? '#f8d7da' : '#d4edda'};">
                                                <input type="checkbox" id="carrier_${index}_${carrier.replace(/\s+/g, '_')}" 
                                                       ${alreadySubmitted.includes(carrier) ? 'disabled checked' : ''}>
                                                <label for="carrier_${index}_${carrier.replace(/\s+/g, '_')}">${carrier} 
                                                ${alreadySubmitted.includes(carrier) ? '(Already submitted)' : ''}
                                                </label>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            ${recommendations.secondary.length > 0 ? `
                                <div class="carrier-section">
                                    <h4 style="color: #f39c12;">‚ö° Secondary Options</h4>
                                    <div class="carrier-grid">
                                        ${recommendations.secondary.map(carrier => `
                                            <div class="carrier-checkbox" style="background: ${alreadySubmitted.includes(carrier) ? '#f8d7da' : '#fff3cd'};">
                                                <input type="checkbox" id="carrier_${index}_${carrier.replace(/\s+/g, '_')}" 
                                                       ${alreadySubmitted.includes(carrier) ? 'disabled checked' : ''}>
                                                <label for="carrier_${index}_${carrier.replace(/\s+/g, '_')}">${carrier}
                                                ${alreadySubmitted.includes(carrier) ? '(Already submitted)' : ''}
                                                </label>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            ${recommendations.other.length > 0 ? `
                                <div class="carrier-section">
                                    <h4 style="color: #6c757d;">üìã Other Carriers</h4>
                                    <div class="carrier-grid">
                                        ${recommendations.other.map(carrier => `
                                            <div class="carrier-checkbox">
                                                <input type="checkbox" id="carrier_${index}_${carrier.replace(/\s+/g, '_')}" 
                                                       ${alreadySubmitted.includes(carrier) ? 'disabled checked' : ''}>
                                                <label for="carrier_${index}_${carrier.replace(/\s+/g, '_')}">${carrier}
                                                ${alreadySubmitted.includes(carrier) ? '(Already submitted)' : ''}
                                                </label>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            <button onclick="submitToCarriers(${index}, '${quoteId}')" class="submit-button" id="submit_${index}">
                                Submit Selected Carriers
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getSmartCarrierRecommendations(operation, commodity) {
            const priority = [];
            const secondary = [];
            const other = [];
            
            const allCarriers = ['Progressive', 'Sentry', 'Bellingham', 'ATM', 'BHHC', 'Interline', 'AmCom', 'Coverwhale', 'Burns and Wilcox', 'IMCO', 'Schuburg', 'Coastal', 'NTA', 'CRC', 'Great American', 'IAT', 'RT Specialty'];
            
            // Smart recommendations based on operation type and commodity
            const opLower = operation.toLowerCase();
            const commLower = commodity.toLowerCase();
            
            // Get years in business from the current quote being processed
            const currentQuote = dashboardData.quotes.find(q => 
                (q['Operation Type'] || '').toLowerCase() === opLower && 
                (q['Commodity'] || '').toLowerCase() === commLower
            );
            const yearsInBusiness = currentQuote ? (currentQuote['Years in Business'] || '0') : '0';
            const hasExperience = yearsInBusiness !== 'New' && yearsInBusiness !== 'new' && parseInt(yearsInBusiness) >= 3;
            
            // Progressive - best for CA dump trucks and construction
            if (commLower.includes('construction') || commLower.includes('dump') || opLower.includes('dump')) {
                priority.push('Progressive');
            } else {
                secondary.push('Progressive');
            }
            
            // Sentry - prioritized for 3+ years in business with specific commodities
            if (hasExperience && (
                commLower.includes('refrigerated') || 
                commLower.includes('refer') ||
                commLower.includes('general freight') || 
                commLower.includes('general') ||
                commLower.includes('flatbed') || 
                commLower.includes('auto') ||
                commLower.includes('container') || 
                commLower.includes('intermodal')
            )) {
                priority.push('Sentry');
            } else {
                secondary.push('Sentry');
            }
            
            // Bellingham - local/regional under 250 miles
            if (opLower.includes('local') || opLower.includes('regional')) {
                priority.push('Bellingham');
            } else {
                other.push('Bellingham');
            }
            
            // IAT - fleet specialist for long haul
            if (opLower.includes('long') || opLower.includes('haul')) {
                priority.push('IAT');
            } else {
                secondary.push('IAT');
            }
            
            // Add remaining carriers to appropriate categories
            allCarriers.forEach(carrier => {
                if (!priority.includes(carrier) && !secondary.includes(carrier) && !other.includes(carrier)) {
                    if (['ATM', 'BHHC', 'Interline'].includes(carrier)) {
                        secondary.push(carrier);
                    } else {
                        other.push(carrier);
                    }
                }
            });
            
            return { priority, secondary, other };
        }

        function selectAllRecommended(quoteIndex) {
            const quoteCard = document.getElementById(`quote-${quoteIndex}`);
            const recommendedCheckboxes = quoteCard.querySelectorAll('.carrier-section:first-of-type input[type="checkbox"]:not(:disabled)');
            recommendedCheckboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
        }

        function clearAllCarriers(quoteIndex) {
            const quoteCard = document.getElementById(`quote-${quoteIndex}`);
            const allCheckboxes = quoteCard.querySelectorAll('input[type="checkbox"]:not(:disabled)');
            allCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        async function submitToCarriers(quoteIndex, quoteId) {
            const submitButton = document.getElementById(`submit_${quoteIndex}`);
            const quoteCard = document.getElementById(`quote-${quoteIndex}`);
            
            // Get selected carriers
            const selectedCarriers = [];
            const checkboxes = quoteCard.querySelectorAll('input[type="checkbox"]:checked:not(:disabled)');
            
            checkboxes.forEach(checkbox => {
                const label = checkbox.nextElementSibling.textContent.split('(')[0].trim();
                selectedCarriers.push(label);
            });
            
            if (selectedCarriers.length === 0) {
                alert('Please select at least one carrier to submit to.');
                return;
            }
            
            try {
                submitButton.disabled = true;
                submitButton.textContent = 'Submitting...';
                
                // Send to Google Apps Script
                const result = await submitCarrierAttempts(quoteId, selectedCarriers);
                
                if (result.success) {
                    showStatus('success', `Successfully submitted ${selectedCarriers.length} carrier attempts for quote ${quoteId}`);
                    
                    // Refresh data to show the new submissions
                    setTimeout(() => {
                        loadData();
                    }, 1000);
                } else {
                    throw new Error(result.error || 'Failed to submit carrier attempts');
                }
                
            } catch (error) {
                console.error('Error submitting carriers:', error);
                showStatus('error', `Failed to submit carriers: ${error.message}`);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Submit Selected Carriers';
            }
        }

        async function submitCarrierAttempts(quoteId, carriers) {
            const url = `${APPS_SCRIPT_URL}?action=addCarrierAttempts&quoteId=${encodeURIComponent(quoteId)}&carriers=${encodeURIComponent(JSON.stringify(carriers))}&timestamp=${Date.now()}`;
            
            try {
                const response = await fetch(url, { method: 'GET' });
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error in submitCarrierAttempts:', error);
                return { success: false, error: error.message };
            }
        }

        function updateCarrierPerformance() {
            const carrierStats = {};
            
            dashboardData.carrierAttempts.forEach(attempt => {
                const carrier = attempt['Carrier Name'] || attempt.carrierName || attempt.carrier;
                if (!carrier) return;
                
                if (!carrierStats[carrier]) {
                    carrierStats[carrier] = { submitted: 0, quoted: 0, won: 0 };
                }
                
                carrierStats[carrier].submitted++;
                
                const quoted = (attempt['Quoted (Y/N)'] || '').toString().toUpperCase() === 'Y' || 
                              (attempt['Quoted (Y/N)'] || '').toString().toLowerCase() === 'yes';
                              
                const won = (attempt['Won (Y/N)'] || '').toString().toUpperCase() === 'Y' || 
                           (attempt['Won (Y/N)'] || '').toString().toLowerCase() === 'yes';
                
                if (quoted) {
                    carrierStats[carrier].quoted++;
                    if (won) {
                        carrierStats[carrier].won++;
                    }
                }
            });
            
            const tbody = document.getElementById('carrier-table-body');
            tbody.innerHTML = Object.entries(carrierStats).map(([carrier, stats]) => {
                const quoteRate = stats.submitted > 0 ? (stats.quoted / stats.submitted * 100).toFixed(1) : 0;
                const winRate = stats.quoted > 0 ? (stats.won / stats.quoted * 100).toFixed(1) : 0;
                const performance = parseFloat(quoteRate) * parseFloat(winRate) / 100;
                const scoreClass = performance > 50 ? 'score-high' : performance > 25 ? 'score-medium' : 'score-low';
                
                return `
                    <tr>
                        <td><strong>${carrier}</strong></td>
                        <td>${stats.submitted}</td>
                        <td>${stats.quoted}</td>
                        <td>${stats.won}</td>
                        <td>${quoteRate}%</td>
                        <td>${winRate}%</td>
                        <td><span class="performance-score ${scoreClass}">${performance.toFixed(1)}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function updateAnalysis() {
            const operationTypes = {};
            const commodities = {};
            
            // Analyze operations
            dashboardData.quotes.forEach(quote => {
                const operation = quote['Operation Type'] || quote.operationType || quote.operation || quote.Operation;
                const commodity = quote['Commodity'] || quote.commodity || quote.Commodity;
                const status = (quote.Status || quote.status || '').toString().toLowerCase();
                
                const isSuccess = status.includes('bound') || 
                                 status.includes('quoted') ||
                                 status.includes('won') ||
                                 status.includes('complete');
                
                if (operation) {
                    if (!operationTypes[operation]) operationTypes[operation] = { total: 0, success: 0 };
                    operationTypes[operation].total++;
                    if (isSuccess) operationTypes[operation].success++;
                }
                
                if (commodity) {
                    if (!commodities[commodity]) commodities[commodity] = { total: 0, success: 0 };
                    commodities[commodity].total++;
                    if (isSuccess) commodities[commodity].success++;
                }
            });
            
            const container = document.getElementById('analysis-content');
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div>
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">Operation Types</h3>
                        ${Object.entries(operationTypes).map(([type, data]) => {
                            const rate = data.total > 0 ? (data.success / data.total * 100).toFixed(1) : 0;
                            return `
                                <div style="background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #3498db;">
                                    <div style="font-weight: bold; color: #2c3e50;">${type}</div>
                                    <div style="color: #6c757d; margin-top: 5px;">
                                        ${data.total} submissions ‚Ä¢ ${data.success} success ‚Ä¢ ${rate}% rate
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div>
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">Commodities</h3>
                        ${Object.entries(commodities).map(([commodity, data]) => {
                            const rate = data.total > 0 ? (data.success / data.total * 100).toFixed(1) : 0;
                            return `
                                <div style="background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #27ae60;">
                                    <div style="font-weight: bold; color: #2c3e50;">${commodity}</div>
                                    <div style="color: #6c757d; margin-top: 5px;">
                                        ${data.total} submissions ‚Ä¢ ${data.success} success ‚Ä¢ ${rate}% rate
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function updateSubmissions() {
            const tbody = document.getElementById('submissions-table-body');
            tbody.innerHTML = dashboardData.quotes.map(quote => {
                const dateValue = quote.Date || quote.date;
                let displayDate = 'Unknown';
                if (dateValue) {
                    try {
                        displayDate = new Date(dateValue).toLocaleDateString();
                    } catch (e) {
                        displayDate = dateValue.toString();
                    }
                }
                
                const status = quote.Status || quote.status || 'Unknown';
                const isSuccess = status.toLowerCase().includes('bound') || 
                                 status.toLowerCase().includes('quoted') ||
                                 status.toLowerCase().includes('won') ||
                                 status.toLowerCase().includes('complete');
                const statusClass = isSuccess ? 'score-high' : 'score-medium';
                
                return `
                    <tr>
                        <td>${displayDate}</td>
                        <td>${quote['Customer Name'] || quote.customerName || '-'}</td>
                        <td>${quote['Quote ID (USDOT)'] || quote.quoteId || quote.ID || '-'}</td>
                        <td>${quote['Operation Type'] || quote.operationType || quote.operation || '-'}</td>
                        <td>${quote['Commodity'] || quote.commodity || '-'}</td>
                        <td><span class="performance-score ${statusClass}">${status}</span></td>
                    </tr>
                `;
            }).join('');
        }
    </script>
</body>
</html>
