// Google Apps Script - DEBUG VERSION for Ed Zahnle Dashboard
// This version provides detailed logging to identify the connection issue

function doGet(e) {
  console.log('=== doGet called ===');
  console.log('Parameters:', e.parameter);
  
  try {
    const action = e.parameter.action;
    const callback = e.parameter.callback;
    
    let data;
    
    if (action === 'getDashboardData') {
      data = getDashboardData();
    } else {
      data = { error: 'Unknown action: ' + action };
    }
    
    data.lastUpdated = new Date().toISOString();
    
    if (callback) {
      // JSONP response
      const jsonpResponse = callback + '(' + JSON.stringify(data) + ');';
      return ContentService
        .createTextOutput(jsonpResponse)
        .setMimeType(ContentService.MimeType.JAVASCRIPT);
    } else {
      // Regular JSON response
      return ContentService
        .createTextOutput(JSON.stringify(data))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
  } catch (error) {
    console.error('Error in doGet:', error);
    
    const errorData = {
      error: 'Server error: ' + error.toString(),
      lastUpdated: new Date().toISOString(),
      debug: {
        errorMessage: error.message,
        errorStack: error.stack
      }
    };
    
    if (e.parameter.callback) {
      const jsonpResponse = e.parameter.callback + '(' + JSON.stringify(errorData) + ');';
      return ContentService
        .createTextOutput(jsonpResponse)
        .setMimeType(ContentService.MimeType.JAVASCRIPT);
    } else {
      return ContentService
        .createTextOutput(JSON.stringify(errorData))
        .setMimeType(ContentService.MimeType.JSON);
    }
  }
}

function getDashboardData() {
  console.log('=== getDashboardData called ===');
  
  try {
    // First, let's get the active spreadsheet instead of hardcoding ID
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    console.log('Spreadsheet name:', spreadsheet.getName());
    
    // List all sheet names
    const allSheets = spreadsheet.getSheets();
    const sheetNames = allSheets.map(sheet => sheet.getName());
    console.log('Available sheet names:', sheetNames);
    
    // Try different possible names for Quote Submissions
    let quotesSheet = null;
    const possibleQuoteNames = ['Quote Submissions', 'QuoteSubmissions', 'Quotes', 'quote submissions'];
    
    for (const name of possibleQuoteNames) {
      quotesSheet = spreadsheet.getSheetByName(name);
      if (quotesSheet) {
        console.log('Found quotes sheet with name:', name);
        break;
      }
    }
    
    if (!quotesSheet) {
      // Try the first sheet if no match
      quotesSheet = allSheets[0];
      console.log('Using first sheet as quotes:', quotesSheet.getName());
    }
    
    // Get ALL data from quotes sheet
    const quotesDataRange = quotesSheet.getDataRange();
    const quotesData = quotesDataRange.getValues();
    console.log('Quotes sheet data range:', quotesDataRange.getA1Notation());
    console.log('Total rows in quotes sheet:', quotesData.length);
    
    if (quotesData.length === 0) {
      throw new Error('No data found in quotes sheet');
    }
    
    const quotesHeaders = quotesData[0];
    console.log('Quote headers:', quotesHeaders);
    
    const quotesRows = quotesData.slice(1);
    console.log('Quote data rows:', quotesRows.length);
    
    // Log first few rows of raw data
    console.log('First 3 quote rows:', quotesRows.slice(0, 3));
    
    // Convert quotes to objects - NO FILTERING
    const quotes = quotesRows.map((row, index) => {
      const quote = {};
      quotesHeaders.forEach((header, headerIndex) => {
        const cleanHeader = header.toString().trim();
        let value = row[headerIndex];
        
        // Handle dates
        if (cleanHeader.toLowerCase().includes('date') && value instanceof Date) {
          value = value.toISOString().split('T')[0];
        }
        
        quote[cleanHeader] = value;
      });
      
      // Log each quote as we process it
      if (index < 5) {
        console.log(`Quote ${index + 1}:`, quote);
      }
      
      return quote;
    }); // REMOVED THE FILTER - keeping all rows
    
    console.log('Processed quotes count:', quotes.length);
    
    // Now try to find Carrier Attempts sheet
    let carrierSheet = null;
    const possibleCarrierNames = ['Carrier Attempts', 'CarrierAttempts', 'Carriers', 'carrier attempts'];
    
    for (const name of possibleCarrierNames) {
      carrierSheet = spreadsheet.getSheetByName(name);
      if (carrierSheet) {
        console.log('Found carrier sheet with name:', name);
        break;
      }
    }
    
    let carrierAttempts = [];
    
    if (carrierSheet) {
      const carrierDataRange = carrierSheet.getDataRange();
      const carrierData = carrierDataRange.getValues();
      console.log('Carrier sheet data range:', carrierDataRange.getA1Notation());
      console.log('Total rows in carrier sheet:', carrierData.length);
      
      if (carrierData.length > 0) {
        const carrierHeaders = carrierData[0];
        console.log('Carrier headers:', carrierHeaders);
        
        const carrierRows = carrierData.slice(1);
        console.log('Carrier data rows:', carrierRows.length);
        
        // Log first few rows
        console.log('First 3 carrier rows:', carrierRows.slice(0, 3));
        
        carrierAttempts = carrierRows.map((row, index) => {
          const attempt = {};
          carrierHeaders.forEach((header, headerIndex) => {
            const cleanHeader = header.toString().trim();
            let value = row[headerIndex];
            
            if (cleanHeader.toLowerCase().includes('date') && value instanceof Date) {
              value = value.toISOString().split('T')[0];
            }
            
            attempt[cleanHeader] = value;
          });
          
          if (index < 3) {
            console.log(`Carrier attempt ${index + 1}:`, attempt);
          }
          
          return attempt;
        }); // REMOVED FILTER HERE TOO
        
        console.log('Processed carrier attempts count:', carrierAttempts.length);
      }
    } else {
      console.log('No carrier attempts sheet found');
    }
    
    const result = {
      success: true,
      quotes: quotes,
      carrierAttempts: carrierAttempts,
      debug: {
        spreadsheetName: spreadsheet.getName(),
        availableSheets: sheetNames,
        quotesSheetName: quotesSheet ? quotesSheet.getName() : 'NOT FOUND',
        carrierSheetName: carrierSheet ? carrierSheet.getName() : 'NOT FOUND',
        quotesProcessed: quotes.length,
        carrierAttemptsProcessed: carrierAttempts.length,
        quotesHeaders: quotesHeaders,
        carrierHeaders: carrierSheet ? carrierData[0] : [],
        sampleQuote: quotes[0] || null,
        sampleCarrierAttempt: carrierAttempts[0] || null
      }
    };
    
    console.log('Final result summary:', {
      quotes: result.quotes.length,
      carrierAttempts: result.carrierAttempts.length,
      success: result.success
    });
    
    return result;
    
  } catch (error) {
    console.error('Error in getDashboardData:', error);
    return {
      error: 'Failed to load data: ' + error.toString(),
      debug: {
        errorMessage: error.message,
        errorStack: error.stack
      }
    };
  }
}

// Test function you can run manually
function testDataLoad() {
  console.log('=== MANUAL TEST ===');
  const result = getDashboardData();
  console.log('Manual test result:', result);
  
  if (result.success) {
    console.log('SUCCESS! Found quotes:', result.quotes.length);
    console.log('SUCCESS! Found carrier attempts:', result.carrierAttempts.length);
    
    // Show sample data
    if (result.quotes.length > 0) {
      console.log('Sample quote:', result.quotes[0]);
    }
    if (result.carrierAttempts.length > 0) {
      console.log('Sample carrier attempt:', result.carrierAttempts[0]);
    }
  } else {
    console.log('ERROR:', result.error);
  }
  
  return result;
}
